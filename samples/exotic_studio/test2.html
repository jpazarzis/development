<!DOCTYPE html>
<html>
<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<link rel="stylesheet" href="theme3.css" />
<script type='text/javascript' src='compression_logic.js'></script>

<script>

var full_system = null;


function exists_in_array(list,element){
        return list.indexOf(element) > -1;
}


function remove_from_array(list,element){
    var index  = list.indexOf(element);
    if (index > -1) {
        list.splice(index, 1);
    }
}

function Limitation(parentDiv){
        this.parentDiv = parentDiv;
        this.span = document.createElement("span");
        this.span.className = 'limitation_span';
        this.table = document.createElement("table");
        this.span.appendChild(this.table);
        this.matching_counts = []

        this.paintButton = function(button){
            if(exists_in_array(button.parentNode.parentNode.selections,button.horse_number)){
              button.className = 'limitation_selected_button';
            } else {
                button.className = 'limitation_button';
            }
        }

        this.makeButton = function(horse_number){
                var button = document.createElement("button");
                button.className = "limitation_button";
                button.appendChild(document.createTextNode(horse_number));
                button.horse_number = horse_number;
                button.parent_limitation = this;
                button.onclick = function(){
                    var parentRow = this.parentNode.parentNode;
                    if(exists_in_array(parentRow.selections,this.horse_number)){
                        remove_from_array(parentRow.selections,this.horse_number);
                    } else {
                        parentRow.selections.push(this.horse_number);
                    }
                    button.parent_limitation.paintButton(button);
                }
                return button;
        }

        // Create the table containing the full system selections.
        // Note that each row contains an array called selections
        // where we keep all the horse numbers selected for this
        // limitation...
        for(var i = 0; i < full_system.numberOfRaces; ++i){
            var row = document.createElement("tr");
            var cell = document.createElement("td");
            var button = document.createElement("button");
            button.className = "race_number";
            button.appendChild(document.createTextNode(i+1));
            cell.appendChild(button);
            row.appendChild(cell);
            row.selections = [];
            this.table.appendChild(row);
            var s = full_system.selections_per_race(i);
            for(var j = 0; j < s.length; ++j){
                var cell = document.createElement("td");
                var button = this.makeButton(s[j].horse_number);
                cell.appendChild(button);
                cell.horse_number = s[j].horse_number;
                row.appendChild(cell);
                this.paintButton(button);
            }
        } 

        // Create a component containing the possible matches for
        // the specific limitation and add it to the span...
        //this.span.appendChild(document.createElement("br"));

        var matchesTable = document.createElement("table");
        matchesTable.className = 'matching_table';
        var row = document.createElement("tr");
        matchesTable.appendChild(row);
        for(var i = 0; i <= full_system.numberOfRaces; ++i){
            var cell = document.createElement("td");
            var button = document.createElement("button");
            button.className = "matches_counter_unselected";
            button.appendChild(document.createTextNode(i));
            button.parentLimitation = this;
            button.matches = i;
            button.onclick = function(){
                if(exists_in_array(this.parentLimitation.matching_counts,this.matches)){
                    remove_from_array(this.parentLimitation.matching_counts,this.matches);
                    this.className = "matches_counter_unselected";
                } else{
                    this.parentLimitation.matching_counts.push(this.matches);
                    this.className = "matches_counter_selected";
                }
            }

            cell.appendChild(button);
            row.appendChild(cell);
        }

        this.span.appendChild(document.createTextNode('Matches'));
        this.span.appendChild(matchesTable);
        this.parentDiv.appendChild(this.span);



        this.findIndexToInsertHorse = function(race_index, horse_number){
                var index = -1;
                var cells = this.table.rows[race_index].cells;
                var previous = -1;
                // start from 1 because the cell 0 contains the number of the race!
                for(var i = 1; i < cells.length; ++i){
                    var current = cells[i].horse_number;
                    if( current > horse_number && horse_number > previous){
                        index = i;
                        break;
                    }
                    previous = current;
                }
                return index;
        }

     this.insertOrRemoveHorse = function(race_index, horse_number, is_selected){
            if(is_selected){
                var index = this.findIndexToInsertHorse(race_index, horse_number);
                var cell = this.table.rows[race_index].insertCell(index);
                var button = this.makeButton(horse_number);
                cell.appendChild(button);
                cell.horse_number = horse_number;
                this.paintButton(button);

            } else {
                for(var i = 0; i < this.table.rows[race_index].cells.length ; ++i){
                    if(this.table.rows[race_index].cells[i].horse_number == horse_number){
                        this.table.rows[race_index].deleteCell(i);
                        remove_from_array(this.table.rows[race_index].selections,horse_number);
                        break;
                    }
                }
            }
        }
}


function Group(){
        this.limitations = []

        this.div = document.createElement("div");
        this.div.className = "group_div";
        this.div.style.minHeight = ($('#full_system_table').height() + 300) +'px';

        this.titleSpan = document.createElement("span");
        this.titleSpan.className = 'title';
        this.div.appendChild(this.titleSpan);

        $('#groupsCtrl').append(document.createElement("br"));
        $('#groupsCtrl').append(this.div);

        this.updateTitle = function(groupIndex){
            this.titleSpan.innerHTML = '';
            this.titleSpan.appendChild(document.createTextNode('Group# ' + groupIndex));

            var button = document.createElement("button");
            button.className = "full_system_button";
            button.appendChild(document.createTextNode('Add Limitation'));
            button.group = this;
            button.onclick = function(){
                this.group.limitations.push(new Limitation(this.group.div));
            }
            this.titleSpan.appendChild(button);

            button = document.createElement("button");
            button.className = "full_system_button";
            button.appendChild(document.createTextNode('Delete Group'));
            button.group = this;
            button.onclick = function(){    
                  full_system.remove_group(this.group);
                  var parentElement = document.getElementById("groupsCtrl");                    
                  parentElement.removeChild(this.group.div);

            }
            this.titleSpan.appendChild(button);
        }

        this.insertOrRemoveHorse = function(race_index, horse_number, is_selected){
            for(var i=0; i < this.limitations.length; ++i){
                this.limitations[i].insertOrRemoveHorse(race_index, horse_number, is_selected);
            }
        }
}

function makeFullSystem(numberOfRaces,maxHorsesPerRace){
    full_system = new function(){
            this.numberOfRaces = numberOfRaces;
            this.selections = []
            this.groups = []

            for(var i = 0; i < this.numberOfRaces; ++i){
                        var race_selections = []
                        for(var j = 0; j < maxHorsesPerRace; ++j){
                            race_selections.push( 
                                { 
                                    horse_number: j+1, 
                                    is_selected: false 
                                });
                        }
                        this.selections.push(race_selections);
             }

            this.updateFullSystemView = function(){
                    var selections = full_system.selections;
                    var table = document.createElement("table");
                    table.id = 'full_system_table';
                    for(var i=0; i < selections.length; ++i){
                        var row = document.createElement("tr");
                        var cell = document.createElement("td");
                        var button = document.createElement("button");
                        button.className = "race_number";
                        button.appendChild(document.createTextNode(i+1));
                        cell.appendChild(button);


                        row.appendChild(cell);
                        for(var j=0; j < selections[i].length; ++j){
                            var cell = document.createElement("td");
                            var button = document.createElement("button");
                            button.className = "limitation_button";
                            button.appendChild(document.createTextNode(selections[i][j].horse_number));
                            button.race_index = i;
                            button.horse_index = j;
                            button.paint_it = function (){
                                var si = full_system.selections[this.race_index][this.horse_index];
                                this.className = si.is_selected ? 'limitation_selected_button': "limitation_button";
                            }
                            button.onclick = function () { 
                                full_system.toggle_selection(this.race_index, this.horse_index);
                                this.paint_it();
                                full_system.updateCountView();
                            };
                            button.paint_it();
                            cell.appendChild(button);
                            row.appendChild(cell);
                        }
                        table.appendChild(row);
                    }
                    $('#fullSystemCtrl').html('');
                    $('#fullSystemCtrl').append(document.createElement("br"));
                    $('#fullSystemCtrl').append(table);
                    this.updateCountView();
            }

            this.updateCountView = function(){
                var full_system_count = this.countFullSystem();
                $("#statusCtrl").html(full_system_count);
            }

            this.selections_per_race = function (race_index){
                return this.selections[race_index].filter(function(s) { return s.is_selected; });
            }

            this.countFullSystem = function (){
                var counter = 1;
                for(var race_index = 0; race_index < this.selections.length; ++race_index){
                    counter *= this.selections_per_race(race_index).length;
                }
                return counter;
            }

            this.toggle_selection = function (race_index, horse_index){
                this.selections[race_index][horse_index].is_selected = !this.selections[race_index][horse_index].is_selected;

                for(var i = 0; i < this.groups.length; ++i){
                    this.groups[i].insertOrRemoveHorse(race_index, this.selections[race_index][horse_index].horse_number, this.selections[race_index][horse_index].is_selected);
                }
            }

            this.updateGroupTitles = function(){
                for(var i = 0; i < this.groups.length; ++i){
                    this.groups[i].updateTitle(i+1);
                }
            }

            this.add_group = function(){
                this.groups.push(new Group());
                this.updateGroupTitles();
            }

            this.remove_group = function (g){
                remove_from_array(this.groups,g);
                this.updateGroupTitles();
            }
            
        }
}


$(document).ready(function(){
    makeFullSystem(4,20);
    full_system.updateFullSystemView();
})
</script>

</head>
<body style='width=720px'>


<div class='counter_div'>
</div>

<div id='statusCtrl'>

</div>

<div id='optionsCtrl'>
<button title="develop tickets"  onclick="develop_tickets();">
<img src="develop.jpeg" width="30px" height="30px"  />
</button>
</div>


<div class='group_div'>
<span class='title'>Full System</span>
<div id='fullSystemCtrl' class='limitation_span'>
</div>
<br clear="all" /> 
</div>

<div>
<span class='title'><button title="add group of limitations" onclick="full_system.add_group();">
<img src="add.jpeg" width="20px" height="20px"  />
</button>Groups Of Limitations</span>
<div id='groupsCtrl'>
</div>
</div>
<br clear="all" /> 

<div id='ticketsCtrl'>
<span class='title'>Tickets</span>
</div>


</body>
 </html>

