<!DOCTYPE html>
<html>
<link rel="stylesheet" href="theme2.css" />
</head>
<script>
number_of_races = 4
selected_horses = [[], [], [], []]
unused_horses = [
                    [1,2,3,4,5,6,7,8,9,10,11,12,13,14], 
                    [1,2,3,4,5,6,7,8,9,10,11,12,13,14], 
                    [1,2,3,4,5,6,7,8,9,10,11,12,13,14], 
                    [1,2,3,4,5,6,7,8,9,10,11,12,13,14] 
                ]

limitations = []

var assert = function(condition, message) { 
    if (!condition)
        throw Error("Assert failed" + (typeof message !== "undefined" ? ": " + message : ""));
};

function exists(list,element){
        return list.indexOf(element) > -1;
}

function remove(list,element){
    var index  = list.indexOf(element) > -1;
    if (index > -1) {
        list.splice(index, 1);
    }
}

function RaceSelections (race_index) {
    this.selections = [];
    this.race_index = race_index;

    this.to_string = function to_string() {
        var s = '';
        for(var i = 0; i < this.selections.length; ++i){
            s += this.selections[i];
            s += ' , ';
        }
        return s;
    }

    this.remove_left_overs = function remove_left_overs() {
        for(var i = 0; i < this.selections.length; ++i){
            if (!exists(selected_horses[this.race_index],this.selections[i])){
                this.selections.splice(i, 1);
                --i;
            }
        }
    }

    this.size = function size() {
        return this.selections.length;    
    }; 

    this.add = function add(horse_number) {
        this.selections.push(horse_number);    
    };

    this.contains = function contains(horse_number) {
        return (this.selections.indexOf(horse_number) > -1);
    };

    this.remove = function remove(horse_number) {
        var index = this.selections.indexOf(horse_number);
        if (index > -1) {
            this.selections.splice(index, 1);
        }
    };
}

function Limitation(){
    this.race_selections = [];
    this.max_matches_ctrl = null;
    this.min_matches_ctrl = null;

    this.get_max_matches = function get_max_matches(){
        return this.max_matches_ctrl.value;    
    }

    this.get_min_matches = function get_min_matches(){
        return this.min_matches_ctrl.value;
    }


    this.check_combo = function check_combo(combo) {
        var count = 0;
        for(var i = 0; i < combo.length; ++i){
            var selection = combo[i];
            if(this.race_selections[i].contains(selection)){
                count += 1;
            }
        }
        return count >= this.get_min_matches() && count <= this.get_max_matches();
    }


    this.to_string = function to_string() {
        var s = '';
        for(var i = 0; i < this.race_selections.length; ++i){
            s += this.race_selections[i].to_string();
            s += '\n';
        }
        return s;
    }

    for(var i = 0; i < number_of_races; ++i){
        this.race_selections.push(new RaceSelections (i));
    }

    // used in the case where the user removed a horse from the full system
    // to remove it from the limitation
    this.remove_left_overs = function remove_left_overs() {
        for(var i = 0; i < this.race_selections.length; ++i){
            this.race_selections[i].remove_left_overs();
        }

    }
}

function count_full_system(){
    fs = 1;
    for(i=0; i < selected_horses.length; ++i){
        var tokens = selected_horses[i];
        fs = fs * tokens.length;
    }
    return 'Full System Combos: ' +fs;
}

function create_add_horse_button(){
    var s = '<img src="Button-Add-icon.png" width="15" height="15" />';
    return s;
}

function move_horse(row_index,col_index,from_system_name,to_system_name){
    from_system= this[from_system_name];
    to_system= this[to_system_name];
    horse_number = from_system[row_index][col_index];
    from_system[row_index].splice(col_index,1);
    to_system[row_index].push(horse_number);
    update_screen();
}

function sortNumber(a,b) {
    return a - b;
}

function get_system_as_html(system_name, system2_name){
    system = this[system_name];
    system2 = this[system2_name];
    var s = '';
    for(i=0; i < system.length; ++i){
        s += '<tr>';
        s += '<td>' + (i+1) + '</td>';
        var tokens = system[i];
        tokens.sort(sortNumber);
        for(j=0; j < tokens.length; ++j){
            handler = 'onclick=\'move_horse(' + i + ','+j+',\"'+system_name +'\", \"' +system2_name  +'")\'';
            s += '<td><button ' +handler +'>' + tokens[j] + '</button></td>';
        }
        s += '</tr>';
    }
    return s;
}


function update_full_system(){
    var fst = document.getElementById('full_system');
    fst.innerHTML = get_system_as_html('selected_horses','unused_horses');
}

function update_available_horses(){
    var fst = document.getElementById('available_horses');
    fst.innerHTML = get_system_as_html('unused_horses','selected_horses');
}

function update_general_info(){
    var d = document.getElementById('general_info');
    d.innerHTML = count_full_system();
}



function update_screen(){
    update_full_system();
    update_available_horses();
    update_general_info();
    paint_all_limitations();
}

function select_number_of_races(n){

    number_of_races = n

    selected_horses = []  
    for(var i = 0; i < n; ++i){
        selected_horses.push([]);
    }

    unused_horses = []
    for(var i = 0; i < n; ++i){
        unused_horses.push([]);
        for (var j = 1; j <=14; ++j){
            unused_horses[i].push(j); 
        }
    }

    limitations = []

    update_screen();
}


function paint_selection_button(button){
    if(button.selections.contains(button.horse_number)) {
        button.style.background = 'red';
    }
    else {
        button.style.background = '#D1D1E0';
    }
}

function toggle_selection(button){
   
    if(button.selections.contains(button.horse_number)) {
        button.selections.remove(button.horse_number);
    }
    else {
        button.selections.add(button.horse_number);
    }
    paint_selection_button(button);
}

function make_limitation_control(limitation){
    var table = document.createElement('table');
    for(var race_index =0; race_index < number_of_races; ++race_index){
        var table_row = document.createElement('tr');
        var race_number_cell = document.createElement('td');
        race_number_cell.appendChild(document.createTextNode(race_index+1))
        table_row.appendChild(race_number_cell);
        var tokens = selected_horses[race_index];
        tokens.sort(sortNumber);
        for(j=0; j < tokens.length; ++j){
            var cell = document.createElement('td');
            var button = document.createElement('button');
            button.className = "limitation_button";
            button.appendChild(document.createTextNode(tokens[j]))
            button.horse_number = tokens[j];
            button.selections = limitation.race_selections[race_index];
            button.onclick = function () { toggle_selection(this); };
            cell.appendChild(button);
            paint_selection_button(button);
            table_row.appendChild(cell);
        }
        table.appendChild(table_row);
    }
    return table;
}

function get_possible_matches_as_span(limitation){
    var span = document.createElement('span');
    var max_matches = number_of_races;
    var from_select = document.createElement("select");
    for(var i = 0; i <= max_matches; ++i){
        var option = document.createElement("option");
        option.value= i;
        option.innerHTML=i;
        from_select.appendChild(option);
    }


    var label = document.createElement("Label");
    label.innerHTML = "from";
    label.className = 'from_to_label';
    span.appendChild(label);
    span.appendChild(from_select);
    span.appendChild(document.createElement("br"));

    limitation.min_matches_ctrl = from_select;
    
    var to_select = document.createElement("select");
    for(var i = 0; i <= max_matches; ++i){
        var option = document.createElement("option");
        option.value= i;
        option.innerHTML=i;
        to_select.appendChild(option);
    }

    label = document.createElement("Label");
    label.innerHTML = "to";
    label.className = 'from_to_label';

    limitation.max_matches_ctrl = to_select;
    
    span.appendChild(label);
    span.appendChild(to_select);
    return span;
}

function delete_limitation(limitation_index){
    limitations.splice(limitation_index, 1);
    paint_all_limitations();
}


function paint_limitation(limitation){
    var limitation_index = limitations.indexOf(limitation) + 1 ;
    var label = document.createElement("div");
    label.innerHTML = limitation_index;
    label.className = 'title';
    limitation.remove_left_overs();
    var div = document.getElementById('limitation_div');
    
    var element = document.createElement('span');
    element.appendChild(label);
    element.appendChild(document.createElement("br"));

    element.className = "limitation_span";
    element.appendChild(make_limitation_control(limitation));
    element.appendChild(document.createElement("hr"));
    element.appendChild(get_possible_matches_as_span(limitation));

    var button = document.createElement('button');
    button.className = "limitation_button";
    button.appendChild(document.createTextNode('delete'))
    button.onclick = function () { delete_limitation(limitation_index - 1); };
    element.appendChild(button);

    div.appendChild(element);
}

function paint_all_limitations(){
    var div = document.getElementById('limitation_div');
    div.innerHTML = '';
    for(var i = 0; i < limitations.length; ++i){
        paint_limitation(limitations[i])
        
    }
}

function add_limitation(){
    var limitation = new Limitation();
    limitations.push(limitation);
    paint_limitation(limitation);
}

function combos(head, tail)
{
   if(tail.length == 0) 
        return head;
   
   if(head.length == 0) {
        head = []
        for(var i = 0; i < tail[0].length; ++i){
            head.push([tail[0][i]]);
        }
        return combos(head, tail.slice(1));
   }
    
   var new_head = [];  
   for(var i = 0; i < head.length; ++i) {
        for(var j = 0; j < tail[0].length; ++j){
            var x = head[i].slice(0);     
            x.push(tail[0][j]);
            new_head.push(x); 
        }
   }

   return combos(new_head, tail.slice(1));
}

function count_combinations(){

    full_system = combos([],selected_horses);
    developed_system = []
    for(var i = 0; i < full_system.length; ++i){
        var accept = true;
        for(var j = 0; j < limitations.length; ++j){
            if(limitations[j].check_combo(full_system[i])==false){
                accept = false;
                break;
            }
        }
        if(accept == true){
            developed_system.push(full_system[i]);
        }
    }
    var d = document.getElementById('developed_system_count');
    d.innerHTML = 'Developed System Combos: '+ developed_system.length;
}

</script>

</head>
<body onload="update_screen()">

<div>
 <p>
          <input type = "radio"
                 name = "radSize"
                 id = "sizeSmall"
                 value = "pick4"
                 onchange="select_number_of_races(4)"
                 checked = "checked" >pick4 </input>

          <input type = "radio"
                 name = "radSize"
                 id = "sizeSmall"
                 onchange="select_number_of_races(5)"
                 value = "pick5">pick5 </input> 

          <input type = "radio"
                 name = "radSize"
                 id = "sizeSmall"
                 onchange="select_number_of_races(6)"
                 value = "pick6">pick6</input> 
        </p>       
</div>


<div>
<span class='system_span'>
<span class='title'>
Full System
</span>
<table id='full_system'>
</table>
</div>
</span>
<span class='system_span'>
<span class='title'>
Available
</span>
<table id='available_horses'>
</table>
</span>
</div>
<br clear="all" /> 
<br/>
<div id='general_info'>
</div>
<div id='developed_system_count'>
</div>
<br/>
<div>
<button onclick=add_limitation()>Add Limitation</button>
<button onclick=count_combinations()>Count Combinations</button>
</div>
<br/>
<div id='limitation_div'>
</div>
</body>
 </html>
